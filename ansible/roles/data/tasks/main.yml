---

- name: Import base organizations
  shell: "{{ virtual_environment }}/bin/paster --plugin=ckanext-ytp-tasks ytp-task-add -c {{ ckan_ini }} --execute import_base_organizations ckanext.ytp.tasks.organization_import daily '{\"url\": \"https://raw2.github.com/yhteentoimivuuspalvelut/ytp-tools/master/organization.json\"}'"
  tags:
  - data

- name: Download ontology file
  get_url: url="http://onki.fi/en/browser/downloadfile/juho?o=http%3A%2F%2Fwww.yso.fi%2Fonto%2Fjuho&f=juho%2Fyso%2Bvnas%2Beks%2Bveps160610a-ONKIIN.rdf-xml.owl" dest="{{ cache_path }}/juho.owl"
  register: ontology
  tags:
  - ontology
  - data

- name: Copy ontology script
  copy: src="parse-tags-from-ontology.py" dest="{{ cache_path }}/parse-tags-from-ontology.py"
  register: ontology_script
  tags:
  - ontology
  - data

- name: Import dataset tags from JUHO ontology
  command: ./bin/python {{ cache_path }}/parse-tags-from-ontology.py {{ harvest_username }} {{ virtual_environment }} {{ ckan_ini }} {{ cache_path }}/juho.owl chdir="{{ virtual_environment }}"
  when: ontology|changed or ontology_script|changed
  tags:
  - ontology
  - data

- name: Import harvest organizations
  shell: "{{ virtual_environment }}/bin/paster --plugin=ckanext-ytp-tasks ytp-task-add -c {{ ckan_ini }} --wait=120 import_base_organizations ckanext.ytp.tasks.organization_import daily '{\"url\": \"https://raw2.github.com/yhteentoimivuuspalvelut/ytp-tools/master/organization_harvest.json\"}'"
  tags:
  - data

- name: Set harvest sources
  shell: "{{ virtual_environment }}/bin/paster --plugin=ckanext-harvest harvester --config={{ ckan_ini }} source {{ item.name }} {{ item.url }} ckan {{ item.title }} true {{ item.organization }} DAILY '{\"read_only\": true, \"api_key\": \"{{ item.api_key }}\", \"api_version\": 2}'"
  with_items: harvest_sources
  when: harvest_sources != False
  ignore_errors: True
  tags:
  - data
  - non-local
