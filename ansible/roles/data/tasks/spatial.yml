---

- name: Ensure spatial requirements
  apt: pkg="{{ item }}" state=present
  register: postgis_installed
  with_items:
    - postgresql-9.1-postgis
    - python-dev 
    - libxslt1-dev
    - libgeos-c1
  tags:
  - packages
  - ckan
  - spatial

- name: Spatial table references
  command: sudo -u postgres psql -d "{{ ckan_database_name }}" -f "{{ item }}"
  when: postgis_installed|changed
  with_items:
    - "/usr/share/postgresql/9.1/contrib/postgis-1.5/postgis.sql"
    - "/usr/share/postgresql/9.1/contrib/postgis-1.5/spatial_ref_sys.sql"
  tags:
  - ckan
  - spatial

- name: Spatial table rights
  command: sudo -u postgres psql -d "{{ ckan_database_username }}" -c "{{ item }}"
  when: postgis_installed|changed
  with_items:
    - "ALTER TABLE spatial_ref_sys OWNER TO {{ ckan_database_username }};"
    - "ALTER TABLE geometry_columns OWNER TO {{ ckan_database_username }};"
  tags:
  - ckan
  - spatial
