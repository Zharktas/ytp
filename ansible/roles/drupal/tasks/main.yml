---

### Drupal ###

- name: Ensure Drupal packages
  action: apt pkg="{{ item }}" state=latest
  with_items:
    - php5-pgsql
    - php5-gd
    - php5-fpm
    - php5-cli
    - php5
  tags:
  - packages
  - drupal

- name: Fetch drush package
  get_url: url="https://github.com/drush-ops/drush/archive/6.x.zip" dest="{{ cache_path }}/drush-6.x.zip"
  tags:
  - drupal

- name: Unpack drush
  command: unzip "{{ cache_path }}/drush-6.x.zip" chdir="{{ server_path }}" creates="{{ server_path }}/drush-6.x"
  tags:
  - drupal

- name: Setup drush binary link
  file: path="/usr/local/bin/drush" src="{{ server_path }}/drush-6.x/drush" state=link
  tags:
  - drupal 

- name: Set PHP pathinfo
  ini_file: dest=/etc/php5/fpm/php.ini section=PHP option=cgi.fix_pathinfo value=0
  tags:
  - drupal

- name: Set PHP socket (listen)
  ini_file: dest=/etc/php5/fpm/pool.d/www.conf section=www option=listen value=/tmp/phpfpm.socket
  tags:
  - drupal

# required by drush
- name: Create root pgpass
  template: src=pgpass.j2 dest=/root/.pgpass mode=0600 owner=root group=root
  tags:
  - drupal

- name: Create Drupal install script
  template: src=install-drupal.sh.j2 dest="{{ cache_path }}/install-drupal.sh" mode=0700 owner=root group=root
  register: drupal_script
  tags:
  - drupal

- name: Setup Drupal Postgresql user
  sudo_user: postgres
  postgresql_user: user="{{ drupal_database_username }}" password="{{ drupal_database_password }}"
  when: drupal_script|changed
  tags:
  - drupal

- name: Install drupal
  command: ./install-drupal.sh chdir="{{ cache_path }}"
  when: drupal_script|changed
  tags:
  - drupal

- name: Download Drupal drush tools
  command: drush dl -y "{{ item }}" chdir="{{ drupal_root }}" creates="{{ ansible_env.HOME }}/.drush/{{ item }}/"
  with_items:
    - drush_extras
    - drush_language
  tags:
  - drupal

- name: Download Drupal modules
  command: drush dl -y "{{ item }}" chdir="{{ drupal_root }}" creates="{{ drupal_root }}/sites/all/modules/{{ item }}/"
  register: download_modules
  with_items:
    - custom_username_validation
    - views
    - features
    - jquery_update

    - node_export
    - menu_block
    - menu_import
    - libraries
    - services
    - services_menu

    - i18n
    - pathauto
    - token
    - transliteration
    - variable
    - ctools
    - i18nviews
    - l10n_update
    - admin_language
    - wysiwyg
    - drush_editor
    - features_extra
    - imce
    - imce_wysiwyg
  tags:
  - drupal

- name: Enable Drupal modules
  command: drush en -y "{{ item }}" chdir="{{ drupal_root }}"
  when: download_modules|changed
  with_items:
    - custom_username_validation
    - views
    - features
    - jquery_update

    - node_export
    - menu_block
    - menu_block_export
    - menu_import
    - libraries
    - services
    - services_menu
    - rest_server

    - locale
    - i18n
    - i18n_node
    - i18n_block
    - i18n_menu

    - pathauto
    - tokenvariables
    - transliteration
    - variable
    - ctools
    - i18nviews
    - l10n_update
    - admin_language
    - wysiwyg
    - drush_editor
    - fe_block
    - imce
    - imce_wysiwyg
  tags:
  - drupal

- name: Download ckeditor
  command: drush editor-download {{ item }} chdir="{{ drupal_root }}" creates="{{ drupal_root }}/sites/all/libraries/{{ item }}"
  with_items:
    - ckeditor
  tags:
  - drupal

- name: Install wysiwyg module
  shell: rm -rf "{{ drupal_root }}/sites/all/modules/ytp_wysiwyg" && cp -r "{{ cache_path }}/ytp-drupal-wysiwyg" "{{ drupal_root }}/sites/all/modules/ytp_wysiwyg"
  register: install_wysiwyg
  tags:
  - drupal

- name: Enable wysiwyg module
  command: drush en -y ytp_wysiwyg chdir="{{ drupal_root }}"
  when: install_wysiwyg|changed
  tags:
  - drupal

- name: Download Drupal themes
  command: drush dl -y "{{ item }}" chdir="{{ drupal_root }}" creates="{{ drupal_root }}/sites/all/themes/{{ item }}/"
  register: download_themes
  with_items:
    - bootstrap
  tags:
  - drupal

- name: Enable Drupal themes
  command: drush en -y "{{ item }}" chdir="{{ drupal_root }}"
  when: download_themes|changed
  with_items:
    - bootstrap
  tags:
  - drupal

- name: Install YTP Drupal theme
  shell: rm -rf "{{ drupal_theme_path }}/ytp_theme" && cp -r "{{ cache_path }}/ytp-theme-drupal" "{{ drupal_theme_path }}/ytp_theme"
  tags:
  - drupal

- name: Fetch Bootstrap sources
  get_url: url="https://github.com/twbs/bootstrap/archive/v{{ bootstrap_version }}.zip" dest="{{ cache_path }}/v{{ bootstrap_version }}.zip"
  tags:
  - drupal

- name: Extract Bootstrap source to theme
  command: unzip "{{ cache_path }}/v{{ bootstrap_version }}.zip" chdir="{{ drupal_theme_path }}/ytp_theme" creates="{{ drupal_theme_path }}/ytp_theme/bootstrap-{{ bootstrap_version }}"
  tags:
  - drupal

- name: Symlink Boostrap version
  command: ln -sf "bootstrap-{{ bootstrap_version }}" bootstrap chdir="{{ drupal_theme_path }}/ytp_theme"
  tags:
  - drupal

- name: Enable YTP theme
  command: drush en -y ytp_theme chdir="{{ drupal_root }}"
  tags:
  - drupal

- name: Copy Drupal features
  copy: src="{{ item }}.tar" dest="{{ cache_path }}/{{ item }}.tar"
  register: features_copy
  with_items: all_features
  tags:
  - drupal

- name: Prepare features install
  file: path="{{ features_module_path }}" state=directory
  when: features_copy|changed
  tags:
  - drupal

- name: Install features
  command: tar xf "{{ cache_path }}/{{ item }}.tar" --directory="{{ features_module_path }}" # creates={{ features_module_path}/{{ item}
  when: features_copy|changed
  with_items: all_features
  tags:
  - drupal

- name: Enable features
  command: drush en -y "{{ item }}" chdir="{{ drupal_root }}"
  when: features_copy|changed
  with_items: all_features
  tags:
  - drupal

- name: Set default Drupal language
  command: drush language-default fi chdir="{{ drupal_root }}"
  tags:
  - drupal-configuration
  - drupal

- name: Copy drush variable import script
  copy: src=multiple-variables.drush dest="{{ scripts_path }}/multiple-variables.drush" owner=root group=root mode=0750
  tags:
  - drupal-configuration
  - drupal

- name: Copy drush variables
  copy: src=drupal.json dest="{{ cache_path }}/drupal.json" owner=root group=root mode=0600
  register: drush_variables
  tags:
  - drupal-configuration
  - drupal

- name: Set Drupal variables from file
  command: "'{{ scripts_path }}/multiple-variables.drush' '{{ cache_path }}/drupal.json' chdir='{{ drupal_root }}'"
  when: drush_variables|changed
  tags:
  - drupal-configuration
  - drupal

- name: Set Drupal template variables
  command: drush vset "{{ item.variable }}" "{{ item.value }}" chdir='{{ drupal_root }}'
  with_items:
    - { variable: "site_mail", value: "{{ email_from }}" }
    - { variable: "site_name", value: "{{ drupal_site_name }}" }
  tags:
  - drupal-configuration
  - drupal

- name: Copy fix scripts
  copy: src={{ item }}.drush dest={{ scripts_path }}/{{ item }}.drush owner=root group=root mode=750
  register: copy_fix_scripts
  with_items:
    - fix_language_weight
  tags:
  - drupal-configuration
  - drupal

- name: Apply fix scripts
  command: "'{{ scripts_path }}/{{ item }}.drush' chdir='{{ drupal_root }}'"
  when: copy_fix_scripts|changed
  with_items:
    - fix_language_weight
  tags:
  - drupal-configuration
  - drupal

- name: Move blocks
  command: drush block-configure --module={{ item.module }} --delta={{ item.delta }} --region={{ item.region }} chdir="{{ drupal_root }}"
  with_items:
    - { module: views, delta: service_alerts_view-block, region: highlighted }
    - { module: locale, delta: language, region: top_navigation }

- name: Disable blocks
  command: drush block-disable --module={{ item.module }} --delta={{ item.delta }} chdir="{{ drupal_root }}"
  with_items:
    - { module: user, delta: login }
    - { module: system, delta: "powered-by" }
    - { module: node, delta: "recent" }
  tags:
  - drupal-configuration
  - drupal

- name: Refresh Drupal translations
  command: drush l10n-update-refresh chdir="{{ drupal_root }}"
  tags:
  - drupal
  - drupal-translations

- name: Update Drupal translations
  command: drush -y l10n-update chdir="{{ drupal_root }}"
  tags:
  - drupal
  - drupal-translations

- name: Install extra translations
  command: drush language-import {{ item }} {{ cache_path }}/ytp-assets-common/i18n/{{ item }}/LC_MESSAGES/ytp-assets-common.po --replace chdir="{{ drupal_root }}"
  with_items:
  - "fi"
  - "sv"
  when: modules_copy|changed
  tags:
  - drupal
  - drupal-translations

- name: Ensure PHP-FPM is restarted
  service: name=php5-fpm state=restarted
  tags:
  - drupal

- name: Add Drupal roles
  command: drush role-create "{{ item }}" chdir="{{ drupal_root }}"
  ignore_errors: True
  with_items:
  - "{{ drupal_editor_rolename }}"
  - "{{ drupal_ckan_admin_rolename }}"
  tags:
  - drupal
  - roles

- name: Add permissions to editor role
  command: drush role-add-perm "{{ drupal_editor_rolename }}" "{{ item }}" chdir="{{ drupal_root }}"
  with_items:
    - create article content
    - edit own article content
    - edit any article content
    - delete own article content
    - delete any article content
    - administer comments
    - access comments
    - post comments
    - edit own comments
    - view revisions
    - revert revisions
    - delete revisions
    - create service_alert content
    - edit own service_alert content
    - edit any service_alert content
    - delete own service_alert content
    - delete any service_alert content
    - translate interface
    - translate user-defined strings
    - translate content
    - use text format filtered_html
    - use text format full_html
    - create page content
    - edit own page content
    - edit any page content
    - delete own page content
    - delete any page content
    - administer nodes
    - access content overview
    - administer url aliases
    - create url aliases
    - access toolbar
    - customize shortcut links
    - view own unpublished content
    - administer menu
  tags:
  - drupal
  - roles

- name: Add permissions to anonymous role
  command: drush role-add-perm "1" "{{ item }}" chdir="{{ drupal_root }}"
  with_items:
    - services menu retrieve menu

- name: Add default editor user
  command: drush user-create "{{ drupal_default_editor_username }}" --mail="{{ drupal_default_editor_email }}" --password="{{ drupal_default_editor_password }}" chdir="{{ drupal_root }}"
  ignore_errors: True
  tags:
  - drupal

- name: Set user roles
  command: drush user-add-role "{{ item.role }}" --name="{{ item.username }}" chdir="{{ drupal_root }}"
  with_items:
  - { username: "{{ drupal_default_editor_username }}", role: "{{ drupal_editor_rolename }}" }
  - { username: "{{ drupal_default_editor_username }}", role: "{{ drupal_ckan_admin_rolename }}" }
  - { username: "{{ drupal_admin_username }}", role: "{{ drupal_ckan_admin_rolename }}" }
  tags:
  - drupal

- name: Copy imce scripts
  copy: src="../modules/ytp-drupal-wysiwyg/imce_set_for_roles.drush" dest="{{ scripts_path }}/imce_set_for_roles.drush" owner=root group=root mode=750
  register: copy_imce_scripts
  tags:
  - drupal

- name: Apply imce scripts
  command: "'{{ scripts_path }}/imce_set_for_roles.drush' '{{ drupal_editor_rolename }}' chdir='{{ drupal_root }}'"
  when: copy_imce_scripts|changed
  tags:
  - drupal

- name: Create upload paths
  file: path={{ drupal_upload_path }}/{{ item }} owner={{ www_user }} group={{ www_group }} mode=0775 state="directory"
  register: create_upload_paths
  with_items:
    - ""
    - styles
    - images
    - documents
  tags:
  - drupal

- name: Ensure correct permission for Drupal upload directory
  shell: chown -R "{{ www_user }}:{{ www_group }}" "{{ drupal_upload_path }}"
  when: create_upload_paths|changed
  tags:
  - drupal

- name: Update Drupal
  command: drush -y --backup-dir="{{ backup_path }}" up chdir="{{ drupal_root }}"
  tags:
  - drupal

- name: Clear Drupal cache
  command: drush cache-clear all -y chdir="{{ drupal_root }}"
  tags:
  - drupal
