#! /bin/sh

# Installs Drupal if there is no existing content in the Drupal database
# Warning/TODO: if psql check fails then this will reinstall Drupal.
if [ ! `PGPASSWORD={{ postgres.users.drupal.password }} psql -h {{ postgres.server.host }} -tAc "SELECT 1 FROM pg_tables WHERE schemaname='public' AND tablename='node'" {{ postgres.databases.drupal.name }} {{ postgres.users.drupal.username }}` ]; then

    # Download Drupal and copy default settings
    drush dl drupal-7.x --drupal-project-rename={{ drupal_name }} --destination={{ www_root }}
    mkdir -p {{ drupal_root }}/sites/default/files
    chown {{ www_user }}:{{ www_group }} {{ drupal_root }}/sites/default/files

    cp {{ drupal_root }}/sites/default/default.settings.php {{ drupal_root }}/sites/default/settings.php
    chown {{ www_user }}:{{ www_group }} {{ drupal_root }}/sites/default/settings.php

    # Install Drupal
    cd {{ drupal_root }}
    drush site-install -y standard --account-name={{ admin.username }} --account-pass={{ admin.password }} \
        --db-url=pgsql://{{ postgres.users.drupal.username }}:{{ postgres.users.drupal.password }}@{{ postgres.server.host }}:{{ postgres.server.port }}/{{ postgres.databases.drupal.name }} --site-name={{ drupal_site_name }}

    cd -
fi
